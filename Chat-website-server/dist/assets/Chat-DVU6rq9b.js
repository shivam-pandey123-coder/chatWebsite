import{j as e,e as ne,u as B,r as o,f as re,h as P,_ as L,i as _,k as ie,l as ae,m as le,n as ce,o as me,p as ue,q as de,C as pe,t as fe,v as ge,w as he,S as D,g as xe,T as je,I as ye,x as ve,y as N,z as $,N as O,A as Me}from"./index-CmQY8uF5.js";import{F as Ce}from"./index-s6MUvYlc.js";import{M as Ae,a as Se}from"./Menu-o7Jrpwe1.js";import{M as b,L as F}from"./MenuItem-BnJtxvvW.js";import{T as E}from"./Tooltip-BB9SJ6_Q.js";import{c as A,T as w}from"./Typography-CkiNPmcL.js";import{m as ke,A as Le}from"./AppLayout-KKR8ypMH.js";import{R as Te}from"./RenderAttachment-DPopQcW8.js";import{B as be}from"./Menu-Bzmw160M.js";import{u as Fe,a as Ee}from"./hook-DRE589nN.js";import{I as G}from"./IconButton-DqD8OHsx.js";import"./Modal-BScw2avD.js";import"./Toolbar-SJDBs5Az.js";import"./Notifications-WuTS-ZyO.js";import"./AvatarCard-BpJv3msd.js";import"./Avatar-D5RUx6lz.js";import"./ExitToApp-C32h__LY.js";const Ve=A(e.jsx("path",{d:"M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6z"}),"AttachFile"),we=A(e.jsx("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8zm2 11h-3v3.75c0 1.24-1.01 2.25-2.25 2.25S8.5 17.99 8.5 16.75s1.01-2.25 2.25-2.25c.46 0 .89.14 1.25.38V11h4zm-3-4V3.5L18.5 9z"}),"AudioFile"),Ie=A(e.jsx("path",{d:"M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2M8.5 13.5l2.5 3.01L14.5 12l4.5 6H5z"}),"Image"),Re=A(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send"),He=A(e.jsx("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8zm4 18H6V4h7v5h5zM8 15.01l1.41 1.41L11 14.84V19h2v-4.16l1.59 1.59L16 15.01 12.01 11z"}),"UploadFile"),ze=A(e.jsx("path",{d:"M14 2H6.01c-1.1 0-2 .89-2 2L4 20c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8zm-1 7V3.5L18.5 9zm1 5 2-1.06v4.12L14 16v1c0 .55-.45 1-1 1H9c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1h4c.55 0 1 .45 1 1z"}),"VideoFile"),_e=({anchorEl:t,chatId:i})=>{const{isFileMenu:r}=ne(s=>s.misc),a=B(),x=o.useRef(null),p=o.useRef(null),l=o.useRef(null),d=o.useRef(null),[f]=re(),g=()=>a(P(!1)),c=()=>{var s;return(s=x.current)==null?void 0:s.click()},j=()=>{var s;return(s=p.current)==null?void 0:s.click()},T=()=>{var s;return(s=l.current)==null?void 0:s.click()},V=()=>{var s;return(s=d.current)==null?void 0:s.click()},y=async(s,h)=>{const v=Array.from(s.target.files);if(console.log(v),v.length<=0)return;if(v.length>5)return L.error(`You can only send 5 ${h} at a time`);a(_(!0));const M=L.loading(`Sending ${h}...`);g();try{const m=new FormData;m.append("chatId",i),v.forEach(C=>m.append("files",C)),(await f(m)).data?L.success(`${h} sent successfully`,{id:M}):L.error(`Failed to send ${h}`,{id:M})}catch(m){L.error(m,{id:M})}finally{a(_(!1))}};return e.jsx(Ae,{anchorEl:t,open:r,onClose:g,children:e.jsx("div",{style:{width:"10rem"},children:e.jsxs(Se,{children:[e.jsxs(b,{onClick:c,children:[e.jsx(E,{title:"Image",children:e.jsx(Ie,{})}),e.jsx(F,{style:{marginLeft:"0.5rem"},children:"Image"}),e.jsx("input",{type:"file",multiple:!0,accept:"image/png, image/jpeg, image/gif",style:{display:"none"},onChange:s=>y(s,"Images"),ref:x})]}),e.jsxs(b,{onClick:j,children:[e.jsx(E,{title:"Audio",children:e.jsx(we,{})}),e.jsx(F,{style:{marginLeft:"0.5rem"},children:"Audio"}),e.jsx("input",{type:"file",multiple:!0,accept:"audio/mpeg, audio/wav",style:{display:"none"},onChange:s=>y(s,"Audios"),ref:p})]}),e.jsxs(b,{onClick:T,children:[e.jsx(E,{title:"Video",children:e.jsx(ze,{})}),e.jsx(F,{style:{marginLeft:"0.5rem"},children:"Video"}),e.jsx("input",{type:"file",multiple:!0,accept:"video/mp4, video/webm, video/ogg",style:{display:"none"},onChange:s=>y(s,"Videos"),ref:l})]}),e.jsxs(b,{onClick:V,children:[e.jsx(E,{title:"File",children:e.jsx(He,{})}),e.jsx(F,{style:{marginLeft:"0.5rem"},children:"File"}),e.jsx("input",{type:"file",multiple:!0,accept:"*",style:{display:"none"},onChange:s=>y(s,"Files"),ref:d})]})]})})})},De=({message:t,user:i})=>{const{sender:r,content:a,attachments:x=[],createdAt:p}=t,l=(r==null?void 0:r._id)===(i==null?void 0:i._id),d=ie(p).fromNow();return e.jsxs(ke.div,{initial:{opacity:0,x:"-100%"},whileInView:{opacity:1,x:0},style:{alignSelf:l?"flex-end":"flex-start",backgroundColor:"white",color:"black",borderRadius:"5px",padding:"0.5rem",width:"fit-content"},children:[!l&&e.jsx(w,{variant:"caption",fontWeight:"600",color:ae,children:r.name}),a&&e.jsx(w,{children:a}),x.map((f,g)=>{const c=f.url,j=le(c);return e.jsx(be,{children:e.jsx("a",{href:c,target:"_blank",download:!0,style:{color:"black"},children:e.jsx(Te,{file:j,url:c})})},g)}),e.jsx(w,{variant:"caption",color:"text.secondaty",children:d})]})},Ne=o.memo(De),$e=({chatId:t,user:i})=>{var I,R,H,z;const r=ce(),a=B(),x=me(),p=o.useRef(null),l=o.useRef(null),[d,f]=o.useState(""),[g,c]=o.useState([]),[j,T]=o.useState(1),[V,y]=o.useState(null),[s,h]=o.useState(!1),[v,M]=o.useState(!1),m=o.useRef(null),u=ue({chatId:t,skip:!t}),C=de({chatId:t,page:j}),{data:U,setData:Y}=Ce(p,(I=C.data)==null?void 0:I.totalPages,j,T,(R=C.data)==null?void 0:R.msg),Q=[{isError:u.isError,error:u.error},{isError:C.isError,error:C.error}],S=(z=(H=u==null?void 0:u.data)==null?void 0:H.chat)==null?void 0:z.members,W=n=>{f(n.target.value),s||(r.emit(N,{members:S,chatId:t}),h(!0)),m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{r.emit($,{members:S,chatId:t}),h(!1)},[2e3])},q=n=>{a(P(!0)),y(n.currentTarget)},J=n=>{n.preventDefault(),d.trim()&&(r.emit(O,{chatId:t,members:S,message:d}),f(""))};o.useEffect(()=>(r.emit(pe,{userId:i._id,members:S}),a(fe(t)),()=>{c([]),f(""),Y([]),T(1),r.emit(ge,{userId:i._id,members:S})}),[t]),o.useEffect(()=>{l.current&&l.current.scrollIntoView({behavior:"smooth"})},[g]),o.useEffect(()=>{if(u.isError)return x("/")},[u.isError]);const K=o.useCallback(n=>{n.chatId===t&&c(k=>[...k,n.message])},[t]),X=o.useCallback(n=>{n.chatId===t&&M(!0)},[t]),Z=o.useCallback(n=>{n.chatId===t&&M(!1)},[t]),ee=o.useCallback(n=>{if(n.chatId!==t)return;const k={content:n.message,sender:{_id:"kljdfglkjdslf;",name:"Admin"},chat:t,createdAt:new Date().toISOString()};c(oe=>[...oe,k])},[t]),se={[Me]:ee,[O]:K,[N]:X,[$]:Z};Fe(r,se),Ee(Q);const te=[...U,...g];return u.isLoading?e.jsx(he,{}):e.jsx(o.Fragment,{children:e.jsxs(D,{sx:{display:"flex",flexDirection:"column",height:"100%",boxSizing:"border-box",bgcolor:xe},children:[e.jsxs(D,{ref:p,sx:{flexGrow:1,overflowY:"auto",overflowx:"hidden",padding:"1rem"},children:[te.map((n,k)=>e.jsx(Ne,{message:n,user:i},n._id||`${k}-${n.timestamp}`)),v&&e.jsx(je,{}),e.jsx("div",{ref:l})]}),e.jsxs("form",{style:{display:"flex",padding:"1rem",borderTop:"1px solid #ccc",backgroundColor:"#fff",position:"relative"},onSubmit:J,children:[e.jsx(G,{sx:{position:"absolute",left:"1.5rem"},onClick:q,children:e.jsx(Ve,{})}),e.jsx(ye,{placeholder:"Type your message here",style:{flexGrow:1},value:d,onChange:W})," ",e.jsx(G,{type:"submit",sx:{backgroundColor:ve,color:"white",marginLeft:"1rem",padding:"0.5rem","&:hover":{bgcolor:"error.dark"}},children:e.jsx(Re,{})})]}),e.jsx(_e,{anchorEl:V,chatId:t})]})})},ns=Le()($e);export{ns as default};
